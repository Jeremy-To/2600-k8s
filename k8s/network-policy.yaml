apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-external-to-pod1
  namespace: tier-1
spec:
  podSelector:
    matchLabels:
      app: pod1-webapp
  policyTypes:
  - Ingress
  ingress:
  - {} # Allows ingress traffic from all sources (including outside the cluster if service is NodePort/LB)

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-pod1-to-pod2
  namespace: tier-1
spec:
  podSelector:
    matchLabels:
      app: pod1-webapp # Apply this policy to Pod 1
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: tier-2
      podSelector:
        matchLabels:
          app: pod2-ssh # Allow egress only to Pod 2 in tier-2
    ports:
    - protocol: TCP
      port: 22 # Allow egress to Pod 2's SSH port

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-pod1-ingress-to-pod2
  namespace: tier-2
spec:
  podSelector:
    matchLabels:
      app: pod2-ssh # Apply this policy to Pod 2
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: tier-1
      podSelector:
        matchLabels:
          app: pod1-webapp # Allow ingress only from Pod 1 in tier-1
    ports:
    - protocol: TCP
      port: 22 # Allow ingress on the SSH port
